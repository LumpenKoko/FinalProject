<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="chatMapper">
  
  <resultMap type="Chat" id="chat">
  	  <result column="CHAT_NO" property="chatNo"/>
  	  <result column="USER_ID" property="userId"/>
  	  <result column="USER_NICKNAME" property="userNickName"/>
  	  <result column="MESSAGE" property="message"/>
  	  <result column="ROOM_NO" property="roomNo"/>
  	  <result column="USER_NO" property="userNo"/>
  	  <result column="TARGET_ID" property="targetId"/>
  </resultMap>
  
  
   <resultMap type="MasterInfo" id="masterInfo">
   	  <result column="USER_NO" property="masterNo"/>
   	  <result column="USER_ID" property="masterId"/>
   </resultMap>
   
      <resultMap type="UserInfo" id="userInfo">
   	  <result column="USER_NO" property="userNo"/>
   	  <result column="USER_ID" property="userId"/>
   	  <result column="USER_NICKNAME" property="userNickName"/>
   </resultMap>
  
     <insert id="insertChatRoom">
     		INSERT INTO 
     		CHAT(
     		 CHAT_NO,
     		 USER_ID,
     		 USER_NICKNAME,
     		 MESSAGE,
     		 ROOM_NO,
     		 USER_NO,
     		 TARGET_ID,
     		 TARGET_NO,
     		 STATUS
     		)
     		VALUES(
     		 NEXTVAL('SEQ_CHAT'),
     		 #{userId},
     		 #{userNickName},
     		 #{message},
     		 #{roomNo},
     		 #{userNo},
     		 #{targetId},
     		 #{targetNo},
     		 TRUE
     		)
     
     </insert>
    
    <update id="outChatRoom">
    
    	UPDATE CHAT SET STATUS= FALSE
    		WHERE USER_NO = #{userNo}
    
    </update>
    
        <update id="joinChatRoom">
    
    	UPDATE CHAT SET STATUS= TRUE
    		WHERE USER_NO = #{userNo}
    
    </update>
    
      <select id ="selectMasterInfo" resultMap="masterInfo">
           SELECT M.USER_NO, USER_ID  FROM  MEMBER M
            JOIN  LOCATION L 
            ON (M.USER_NO = L.USER_NO)
            WHERE LOCATION_NO = #{locationNo}
            AND USER_KIND = 'Y'
    
    </select>
     
    <select id="selectChats" resultMap="chat">
    	SELECT CHAT_NO,
    		   USER_ID,
    		   USER_NICKNAME,
    		   MESSAGE,
    		   ROOM_NO,
    		   USER_NO,
    		   TARGET_ID
    		   FROM CHAT
    		   WHERE USER_NO != #{USER_NO}
    
    </select>
    
    <select id="selectUserInfo" resultMap="userInfo">
    	SELECT  distinct 
    			USER_ID, 
    			USER_NICKNAME ,
    			USER_NO
    			from chat
    			WHERE USER_NO != #{USER_NO}
    			AND STATUS = TRUE
    
    </select>
    
  
  </mapper>